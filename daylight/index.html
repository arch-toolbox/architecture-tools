<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ¡å…‰è£œæ­£ä¿‚æ•°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v7.2</title>
<style>
  body { font-family: sans-serif; margin: 1rem; }
  .row { display:flex; gap:1rem; flex-wrap:wrap; }
  .panel { border:1px solid #ccc; padding:.5rem; }
  .canvas-wrap { position:relative; width:560px; height:380px; border:1px solid #888; background:#f8f8f8; }
  .canvas-wrap canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
  #log { margin-top:.75rem; white-space:pre-line; font-size:.9rem; }
  label { font-size:.8rem; }
</style>
</head>
<body>
<h1>æ¡å…‰è£œæ­£ä¿‚æ•°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v7.2</h1>

<!-- â‘  ç”¨é€”åœ°åŸŸã¨ã‚­ãƒ£ãƒªãƒ– -->
<div class="panel">
  <h2>åŸºæœ¬è¨­å®š</h2>
  <label>ç”¨é€”åœ°åŸŸï¼š
    <select id="zoneSelect">
      <option value="residential">ä½å±…ç³»</option>
      <option value="commercial">å·¥æ¥­ç³»</option>
      <option value="industrial">å•†æ¥­ç³»</option>
    </select>
  </label>
  <button id="calibBtn">ã‚­ãƒ£ãƒªãƒ–ï¼ˆ4é¢å…±é€šï¼‰</button>
  <button id="exportAllBtn">ğŸ“¸ çµæœä¿å­˜ï¼ˆ2ç”»é¢ï¼‹è¨ˆç®—å€¤ï¼‰</button>
</div>

<!-- â‘¡ 4é¢ã®ç”»åƒèª­ã¿è¾¼ã¿ -->
<div class="panel">
  <h2>4é¢å›³èª­ã¿è¾¼ã¿ï¼ˆåŒä¸€PDFã‚­ãƒ£ãƒ—ãƒãƒ£æƒ³å®šï¼‰</h2>
  <label>å—é¢ï¼š<input type="file" id="southFile" accept="image/*"></label>
  <label>æ±é¢ï¼š<input type="file" id="eastFile" accept="image/*"></label>
  <label>åŒ—é¢ï¼š<input type="file" id="northFile" accept="image/*"></label>
  <label>è¥¿é¢ï¼š<input type="file" id="westFile" accept="image/*"></label>
  <p style="font-size:.7rem;">â€»æœ€åˆã«èª­ã¿è¾¼ã‚“ã ç”»åƒã®è¡¨ç¤ºå€ç‡ã‚’4é¢ã§å…±é€šä½¿ç”¨ã—ã¾ã™</p>
</div>

<div class="row">
  <!-- æ­£é¢ -->
  <div class="panel">
    <h2>æ­£é¢å›³</h2>
    <div style="margin-bottom:.4rem;">
      <label>è¡¨ç¤ºã™ã‚‹å›³é¢ï¼š
        <select id="frontViewSelect">
          <option value="south">å—</option>
          <option value="east">æ±</option>
          <option value="north">åŒ—</option>
          <option value="west">è¥¿</option>
        </select>
      </label>
      <button id="frontGLBtn">GLè¨­å®š</button>
      <button id="frontExportBtn">ğŸ“¸ã“ã®ç”»é¢ã ã‘ä¿å­˜</button>
    </div>
    <div style="margin-bottom:.4rem;">
      <label>ã‚µãƒƒã‚·å¹…(mm): <input type="number" id="sashW" value="1600" style="width:5rem;"></label>
      <label>ã‚µãƒƒã‚·é«˜(mm): <input type="number" id="sashH" value="1100" style="width:5rem;"></label>
    </div>
    <div class="canvas-wrap" id="frontWrap">
      <canvas id="frontImg"></canvas>
      <canvas id="frontDraw"></canvas>
    </div>
    <p style="font-size:.7rem;">ã‚µãƒƒã‚·ï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ä¸Šä¸‹å·¦å³ï¼ãƒˆãƒƒãƒ—ï¼šã‚µãƒƒã‚·ã®çœŸä¸Šã ã‘ä¸Šä¸‹</p>
  </div>

  <!-- å´é¢ -->
  <div class="panel">
    <h2>å´é¢å›³</h2>
    <div style="margin-bottom:.4rem;">
      <label>è¡¨ç¤ºã™ã‚‹å›³é¢ï¼š
        <select id="sideViewSelect">
          <option value="east">æ±</option>
          <option value="south">å—</option>
          <option value="north">åŒ—</option>
          <option value="west">è¥¿</option>
        </select>
      </label>
      <button id="sideGLBtn">GLè¨­å®š</button>
      <button id="sideExportBtn">ğŸ“¸ã“ã®ç”»é¢ã ã‘ä¿å­˜</button>
    </div>
    <div style="margin-bottom:.4rem;">
      <label>å¢ƒç•Œè·é›¢(mm): <input type="number" id="boundaryInput" value="2000" style="width:5rem;"></label>
      <span style="font-size:.7rem;">â€»è¡¨ç¤ºã¯è·é›¢âˆ’90mm</span>
    </div>
    <div class="canvas-wrap" id="sideWrap">
      <canvas id="sideImg"></canvas>
      <canvas id="sideDraw"></canvas>
    </div>
    <p style="font-size:.7rem;">å´é¢ï¼šã‚µãƒƒã‚·ãƒ»ãƒˆãƒƒãƒ—ãƒ»å¢ƒç•Œã‚’å·¦å³ãƒ‰ãƒ©ãƒƒã‚°ï¼æ–œç·šã¯å¸¸æ™‚è¡¨ç¤º</p>
  </div>
</div>

<div id="log"></div>

<script>
/* ==== å…±é€šçŠ¶æ…‹ ==== */
const images = {south:null, east:null, north:null, west:null};
/* ã‚­ãƒ£ãƒ³ãƒã‚¹é«˜ã•380ã§ä¸‹40pxä½™ç™½ã‚’æ®‹ã™GLä½ç½® */
const GLmap  = {south:340, east:340, north:340, west:340};
const glOffsetMap = {south:0, east:0, north:0, west:0};
let scale = 1;
let mode  = "normal";

/* ==== ã‚­ãƒ£ãƒ³ãƒã‚¹ ==== */
const frontImgCv  = document.getElementById('frontImg');
const frontDrawCv = document.getElementById('frontDraw');
const sideImgCv   = document.getElementById('sideImg');
const sideDrawCv  = document.getElementById('sideDraw');
const frontImgCtx  = frontImgCv.getContext('2d');
const frontDrawCtx = frontDrawCv.getContext('2d');
const sideImgCtx   = sideImgCv.getContext('2d');
const sideDrawCtx  = sideDrawCv.getContext('2d');

(function initCanvas(){
  const fw=document.getElementById('frontWrap');
  frontImgCv.width = frontDrawCv.width = fw.clientWidth;
  frontImgCv.height= frontDrawCv.height= fw.clientHeight;
  const sw=document.getElementById('sideWrap');
  sideImgCv.width  = sideDrawCv.width  = sw.clientWidth;
  sideImgCv.height = sideDrawCv.height = sw.clientHeight;
})();

/* ==== UI ==== */
const frontViewSelect = document.getElementById('frontViewSelect');
const sideViewSelect  = document.getElementById('sideViewSelect');
const sashWInput      = document.getElementById('sashW');
const sashHInput      = document.getElementById('sashH');
const boundaryInput   = document.getElementById('boundaryInput');
const zoneSelect      = document.getElementById('zoneSelect');
const logEl           = document.getElementById('log');

/* ==== å›³é¢ä¸Šã®ç‚¹ ==== */
let frontSash = {x:200, y:250};
let frontTop  = {x:200, y:150};
let sideSash  = {x:220, y:250};
let sideTop   = {x:350, y:150};
let sideBoundaryX = 420;
let boundarySide  = 'right';

/* ==== ãƒ‰ãƒ©ãƒƒã‚° ==== */
let frontDragTarget = null;
let frontDragOffset = {x:0,y:0};
let sideDragTarget  = null;
let sideDragOffset  = {x:0,y:0};

/* ==== ã‚­ãƒ£ãƒªãƒ–ç”¨ ==== */
let calibPts = [];

/* ==== ç”»åƒè¡¨ç¤ºã®å…±é€šåŸºæº– ==== */
let baseImageWidth  = null;
let baseImageHeight = null;
let baseDisplayScale = null;

/* ==== è¨ˆç®—çµæœ ==== */
let lastCalc = {
  verticalMm: 0,
  horizontalMm: 0,
  slope: 0,
  coef: 0,
  area: 0,
  zoneText: ''
};

/* ==== ãƒ­ã‚° ==== */
function log(msg){ logEl.textContent = msg; }

/* ==== ç”¨é€”åœ°åŸŸ ==== */
function getZoneParams(){
  const z = zoneSelect.value;
  if (z === 'residential') return {m:6, b:1.4, label:'ä½å±…ç³»'};
  if (z === 'commercial')  return {m:8, b:1,   label:'å·¥æ¥­ç³»'};
  return {m:10, b:1,       label:'å•†æ¥­ç³»'};
}

/* ==== ç”»åƒè¡¨ç¤ºï¼ˆGLã‚ªãƒ•ã‚»ãƒƒãƒˆ + ä¸Šä¸‹åˆ¶é™ã¯GLè¨­å®šæ™‚ã«é©ç”¨ï¼‰ ==== */
function drawImageUniform(ctx, img, canvas, view){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!img) return;
  if (baseImageWidth === null){
    baseImageWidth  = img.width;
    baseImageHeight = img.height;
    baseDisplayScale = canvas.height / img.height;
  }
  const drawW = img.width * baseDisplayScale;
  const drawH = img.height * baseDisplayScale;
  const offsetX = (canvas.width - drawW)/2;
  let offsetY = (canvas.height - drawH)/2 + (glOffsetMap[view] || 0);
  ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
}

/* ==== æ­£é¢æç”» ==== */
function redrawFront(){
  const view = frontViewSelect.value;
  drawImageUniform(frontImgCtx, images[view], frontImgCv, view);
  frontDrawCtx.clearRect(0,0,frontDrawCv.width,frontDrawCv.height);

  // GLãƒ©ã‚¤ãƒ³
  const fGL = GLmap[view];
  frontDrawCtx.setLineDash([4,2]);
  frontDrawCtx.strokeStyle='blue';
  frontDrawCtx.beginPath();
  frontDrawCtx.moveTo(0, fGL);
  frontDrawCtx.lineTo(frontDrawCv.width, fGL);
  frontDrawCtx.stroke();
  frontDrawCtx.setLineDash([]);

  // ã‚µãƒƒã‚·æ ï¼ˆè¡¨ç¤ºç”¨ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ï¼šå¤§ãã™ãã‚‹ã¨ãã¯ç¸®ã‚ã¦è¡¨ç¤ºï¼‰
  let wpx = (Number(sashWInput.value)||0)/scale;
  let hpx = (Number(sashHInput.value)||0)/scale;
  const maxW = frontDrawCv.width * 0.8;
  const maxH = frontDrawCv.height * 0.8;
  if (wpx > maxW) wpx = maxW;
  if (hpx > maxH) hpx = maxH;
  frontDrawCtx.strokeStyle='red';
  frontDrawCtx.strokeRect(frontSash.x-wpx/2, frontSash.y-hpx/2, wpx, hpx);

  // ã‚µãƒƒã‚·ä¸­å¿ƒç‚¹
  frontDrawCtx.fillStyle='red';
  frontDrawCtx.beginPath(); frontDrawCtx.arc(frontSash.x,frontSash.y,4,0,Math.PI*2); frontDrawCtx.fill();

  // ã‚µãƒƒã‚·ä¸­å¿ƒé«˜ã•ã®æ°´å¹³ç·šï¼ˆè£œåŠ©ï¼‰
  frontDrawCtx.setLineDash([2,2]);
  frontDrawCtx.strokeStyle='rgba(0,0,0,0.35)';
  frontDrawCtx.beginPath();
  frontDrawCtx.moveTo(0, frontSash.y);
  frontDrawCtx.lineTo(frontDrawCv.width, frontSash.y);
  frontDrawCtx.stroke();
  frontDrawCtx.setLineDash([]);

  // ãƒˆãƒƒãƒ—ç‚¹
  frontDrawCtx.fillStyle='purple';
  frontDrawCtx.beginPath(); frontDrawCtx.arc(frontTop.x,frontTop.y,4,0,Math.PI*2); frontDrawCtx.fill();

  // ãƒˆãƒƒãƒ—é«˜ã•ã®æ°´å¹³ç·šï¼ˆè£œåŠ©ç·šï¼‰
  frontDrawCtx.setLineDash([2,2]);
  frontDrawCtx.strokeStyle='rgba(128,0,128,0.35)';
  frontDrawCtx.beginPath();
  frontDrawCtx.moveTo(0, frontTop.y);
  frontDrawCtx.lineTo(frontDrawCv.width, frontTop.y);
  frontDrawCtx.stroke();
  frontDrawCtx.setLineDash([]);

}

/* ==== å´é¢æç”» ==== */
function redrawSide(){
  const view = sideViewSelect.value;
  drawImageUniform(sideImgCtx, images[view], sideImgCv, view);
  sideDrawCtx.clearRect(0,0,sideDrawCv.width,sideDrawCv.height);

  // GL
  const sGL = GLmap[view];
  sideDrawCtx.setLineDash([4,2]);
  sideDrawCtx.strokeStyle='blue';
  sideDrawCtx.beginPath();
  sideDrawCtx.moveTo(0, sGL);
  sideDrawCtx.lineTo(sideDrawCv.width, sGL);
  sideDrawCtx.stroke();
  sideDrawCtx.setLineDash([]);

  // ã‚µãƒƒã‚·ç‚¹
  sideDrawCtx.fillStyle='red';
  sideDrawCtx.beginPath(); sideDrawCtx.arc(sideSash.x,sideSash.y,4,0,Math.PI*2); sideDrawCtx.fill();
  sideDrawCtx.setLineDash([2,2]); sideDrawCtx.strokeStyle='rgba(0,0,0,0.3)';
  sideDrawCtx.beginPath(); sideDrawCtx.moveTo(0,sideSash.y); sideDrawCtx.lineTo(sideDrawCv.width,sideSash.y); sideDrawCtx.stroke(); sideDrawCtx.setLineDash([]);

  // å¢ƒç•Œç·š
  sideDrawCtx.setLineDash([4,2]); sideDrawCtx.strokeStyle='black';
  sideDrawCtx.beginPath(); sideDrawCtx.moveTo(sideBoundaryX,0); sideDrawCtx.lineTo(sideBoundaryX,sideDrawCv.height); sideDrawCtx.stroke(); sideDrawCtx.setLineDash([]);

  // ãƒˆãƒƒãƒ—ç‚¹
  sideDrawCtx.fillStyle='purple';
  sideDrawCtx.beginPath(); sideDrawCtx.arc(sideTop.x,sideTop.y,4,0,Math.PI*2); sideDrawCtx.fill();
  sideDrawCtx.setLineDash([2,2]); sideDrawCtx.strokeStyle='rgba(0,0,0,0.3)';
  sideDrawCtx.beginPath(); sideDrawCtx.moveTo(0,sideTop.y); sideDrawCtx.lineTo(sideDrawCv.width,sideTop.y); sideDrawCtx.stroke(); sideDrawCtx.setLineDash([]);

  // æ¡å…‰è£œæ­£ä¿‚æ•°ã®ä»®æƒ³å‚¾ãï¼ˆå¸¸æ™‚ï¼‰
  drawCoefficientLines();
}

/* ==== å´é¢ã®ä¿‚æ•°ç·šï¼ˆ0,1,2,3ï¼‰ ==== */
function drawCoefficientLines(){
  const originX = sideBoundaryX;
  const originY = sideSash.y;
  const isRight = (sideSash.x >= sideBoundaryX);
  const {m,b} = getZoneParams();
  const maxRun=1200;
  [0,1,2,3].forEach(k=>{
    const depthPerHeight = (k+b)/m;
    if (depthPerHeight <= 0) return;
    const run = (isRight?1:-1)*maxRun;
    const height = Math.abs(run)/depthPerHeight;
    const color = (k===0?'gray':k===1?'green':k===2?'blue':'red');
    sideDrawCtx.strokeStyle=color;
    sideDrawCtx.beginPath();
    sideDrawCtx.moveTo(originX,originY);
    sideDrawCtx.lineTo(originX+run,originY-height);
    sideDrawCtx.stroke();
    sideDrawCtx.fillStyle=color;
    sideDrawCtx.font='10px sans-serif';
    sideDrawCtx.fillText(`ä¿‚æ•°${k}`, originX+run*0.4, originY-height-5);
  });
}

/* ==== 4é¢ç”»åƒã®å–ã‚Šè¾¼ã¿ ==== */
function loadImageTo(view, fileEl){
  const f = fileEl.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    const img = new Image();
    img.onload = ()=>{
      images[view]=img;
      redrawFront();
      redrawSide();
    };
    img.src = ev.target.result;
  };
  r.readAsDataURL(f);
}
document.getElementById('southFile').addEventListener('change', e=>loadImageTo('south', e.target));
document.getElementById('eastFile').addEventListener('change',  e=>loadImageTo('east', e.target));
document.getElementById('northFile').addEventListener('change', e=>loadImageTo('north', e.target));
document.getElementById('westFile').addEventListener('change',  e=>loadImageTo('west', e.target));

/* ==== ã‚­ãƒ£ãƒªãƒ– ==== */
document.getElementById('calibBtn').addEventListener('click', ()=>{
  mode='calib';
  calibPts=[];
  log('ã‚­ãƒ£ãƒªãƒ–ä¸­ï¼šã©ã¡ã‚‰ã‹ã®å›³é¢ã§2ç‚¹ã‚¯ãƒªãƒƒã‚¯â†’è·é›¢(mm)ã‚’å…¥åŠ›ï¼ˆ4é¢å…±é€šï¼‰');
});

/* ==== GLãƒœã‚¿ãƒ³ ==== */
document.getElementById('frontGLBtn').addEventListener('click', ()=>{
  mode='frontGL';
  log('æ­£é¢å›³ã®GLãŒã‚ã‚‹ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆç”»åƒã‚’ä¸Šä¸‹ã«å¯„ã›ã¾ã™ï¼‰');
});
document.getElementById('sideGLBtn').addEventListener('click', ()=>{
  mode='sideGL';
  log('å´é¢å›³ã®GLãŒã‚ã‚‹ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆç”»åƒã‚’ä¸Šä¸‹ã«å¯„ã›ã¾ã™ï¼‰');
});

/* ==== GLã‚ªãƒ•ã‚»ãƒƒãƒˆã®å®‰å…¨é©ç”¨ ==== */
function applyGLOffset(view, diff, canvasHeight){
  const margin = 40;
  const minOffset = - (canvasHeight/2 - margin);
  const maxOffset =   (canvasHeight/2 - margin);
  let next = (glOffsetMap[view] || 0) + diff;
  if (next < minOffset) next = minOffset;
  if (next > maxOffset) next = maxOffset;
  glOffsetMap[view] = next;
}

/* ==== æ­£é¢æ“ä½œ ==== */
frontDrawCv.addEventListener('mousedown', e=>{
  const p={x:e.offsetX,y:e.offsetY};

  // ã‚­ãƒ£ãƒªãƒ–
  if (mode === 'calib'){
    calibPts.push(p);
    if (calibPts.length===2){
      const d=Math.hypot(calibPts[1].x-calibPts[0].x, calibPts[1].y-calibPts[0].y);
      const real=prompt('ã“ã®è·é›¢(mm)?','1000');
      if (real && !isNaN(real)){
        scale = Number(real)/d;
        log(`ã‚­ãƒ£ãƒªãƒ–å®Œäº†ï¼š1px = ${scale.toFixed(3)} mmï¼ˆ4é¢å…±é€šï¼‰`);
      } else {
        log('ã‚­ãƒ£ãƒªãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      }
      mode='normal';
      placeBoundaryFromInput();
      redrawFront(); redrawSide(); calcCoefficient();
    }
    return;
  }

  // GLï¼ˆç”»åƒã‚’å¯„ã›ã‚‹ï¼‰
  if (mode === 'frontGL'){
    const view = frontViewSelect.value;
    const targetGL = GLmap[view];
    const diff = targetGL - p.y;
    applyGLOffset(view, diff, frontImgCv.height);
    mode='normal';
    redrawFront();
    return;
  }

  // â‘  ã¾ãšãƒˆãƒƒãƒ—ç‚¹ã‚’å„ªå…ˆã—ã¦ãƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šï¼ˆã‚µãƒƒã‚·ãŒå¤§ããã¦ã‚‚è§¦ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
  if (Math.hypot(p.x-frontTop.x,p.y-frontTop.y) < 10){
    frontDragTarget='top';
    frontDragOffset={y:p.y-frontTop.y};
    return;
  }

  // â‘¡ æ¬¡ã«ã‚µãƒƒã‚·æ 
  const wpx=(Number(sashWInput.value)||0)/scale;
  const hpx=(Number(sashHInput.value)||0)/scale;
  if (p.x>=frontSash.x-wpx/2 && p.x<=frontSash.x+wpx/2 &&
      p.y>=frontSash.y-hpx/2 && p.y<=frontSash.y+hpx/2){
    frontDragTarget='sash';
    frontDragOffset={x:p.x-frontSash.x,y:p.y-frontSash.y};
    return;
  }
});
frontDrawCv.addEventListener('mousemove', e=>{
  if (!frontDragTarget) return;
  const p={x:e.offsetX,y:e.offsetY};
  if (frontDragTarget==='sash'){
    frontSash.x = p.x - frontDragOffset.x;
    frontSash.y = p.y - frontDragOffset.y;
  } else if (frontDragTarget==='top'){
    frontTop.y = p.y - frontDragOffset.y;
    frontTop.x = frontSash.x;
  }
  redrawFront();
  syncFrontToSide();
});
window.addEventListener('mouseup', ()=>{ frontDragTarget=null; sideDragTarget=null; });

/* ==== å´é¢æ“ä½œ ==== */
sideDrawCv.addEventListener('mousedown', e=>{
  const p={x:e.offsetX,y:e.offsetY};

  // ã‚­ãƒ£ãƒªãƒ–
  if (mode === 'calib'){
    calibPts.push(p);
    if (calibPts.length===2){
      const d=Math.hypot(calibPts[1].x-calibPts[0].x, calibPts[1].y-calibPts[0].y);
      const real=prompt('ã“ã®è·é›¢(mm)?','1000');
      if (real && !isNaN(real)){
        scale=Number(real)/d;
        log(`ã‚­ãƒ£ãƒªãƒ–å®Œäº†ï¼š1px = ${scale.toFixed(3)} mmï¼ˆ4é¢å…±é€šï¼‰`);
      } else {
        log('ã‚­ãƒ£ãƒªãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      }
      mode='normal';
      placeBoundaryFromInput();
      redrawFront(); redrawSide(); calcCoefficient();
    }
    return;
  }

  // å´é¢ã®GL
  if (mode === 'sideGL'){
    const view = sideViewSelect.value;
    const targetGL = GLmap[view];
    const diff = targetGL - p.y;
    applyGLOffset(view, diff, sideImgCv.height);
    mode='normal';
    redrawSide();
    return;
  }

  // ãƒˆãƒƒãƒ—ã‚’å…ˆã«åˆ¤å®š
  if (Math.hypot(p.x-sideTop.x,p.y-sideTop.y)<10){
    sideDragTarget='top';
    sideDragOffset={x:p.x-sideTop.x};
    return;
  }

  // ã‚µãƒƒã‚·ç‚¹
  if (Math.hypot(p.x-sideSash.x,p.y-sideSash.y)<10){
    sideDragTarget='sash';
    sideDragOffset={x:p.x-sideSash.x};
    return;
  }

  // å¢ƒç•Œ
  if (Math.abs(p.x-sideBoundaryX)<8 && Math.abs(p.y-sideSash.y)<20){
    sideDragTarget='boundary';
    sideDragOffset={x:p.x-sideBoundaryX};
    return;
  }
});
sideDrawCv.addEventListener('mousemove', e=>{
  if (!sideDragTarget) return;
  const p={x:e.offsetX,y:e.offsetY};
  if (sideDragTarget==='sash'){
    sideSash.x = p.x - sideDragOffset.x;
  } else if (sideDragTarget==='top'){
    sideTop.x = p.x - sideDragOffset.x;
  } else if (sideDragTarget==='boundary'){
    sideBoundaryX = p.x - sideDragOffset.x;
    if (scale){
      const distMm = Math.abs(sideBoundaryX - sideSash.x) * scale + 90;
      boundaryInput.value = Math.round(distMm);
      boundarySide = (sideBoundaryX >= sideSash.x)?'right':'left';
    }
  }
  redrawSide();
  calcCoefficient();
});

/* ==== å¢ƒç•Œå…¥åŠ›ã‚’å´é¢ã«åæ˜  ==== */
function placeBoundaryFromInput(){
  if (!scale) return;
  let distMm = Number(boundaryInput.value)||0;
  let adjMm = distMm - 90;
  if (adjMm < 0) adjMm = 0;
  const adjPx = adjMm / scale;
  if (boundarySide === 'right'){
    sideBoundaryX = sideSash.x + adjPx;
  } else {
    sideBoundaryX = sideSash.x - adjPx;
  }
}
boundaryInput.addEventListener('input', ()=>{
  placeBoundaryFromInput();
  redrawSide();
  calcCoefficient();
});

/* ==== é¢åˆ‡æ›¿ ==== */
frontViewSelect.addEventListener('change', ()=>{
  redrawFront();
  syncFrontToSide();
});
sideViewSelect.addEventListener('change', ()=>{
  redrawSide();
  syncFrontToSide();
});

/* ==== æ­£é¢â†’å´é¢ é«˜ã•é€£å‹• ==== */
function syncFrontToSide(){
  const fView = frontViewSelect.value;
  const sView = sideViewSelect.value;
  const fGL   = GLmap[fView];
  const sGL   = GLmap[sView];

  const sashMm = (fGL - frontSash.y) * scale;
  sideSash.y   = sGL - sashMm / scale;

  const topMm  = (fGL - frontTop.y) * scale;
  sideTop.y    = sGL - topMm / scale;

  placeBoundaryFromInput();
  redrawSide();
  calcCoefficient();
}

/* ==== æ¡å…‰è¨ˆç®— ==== */
function calcCoefficient(){
  const verticalPx = frontSash.y - frontTop.y;
  if (verticalPx <= 0){
    log('ãƒˆãƒƒãƒ—ãŒã‚µãƒƒã‚·ã‚ˆã‚Šä¸‹ã«ã‚ã‚Šã¾ã™');
    return;
  }
  const verticalMm = verticalPx * scale;
  const horizontalPx = Math.abs(sideTop.x - sideBoundaryX);
  const horizontalMm = horizontalPx * scale;

  const {m,b,label} = getZoneParams();
  const slope = horizontalMm / verticalMm;
  let coef = slope * m - b;
  if (coef < 0) coef = 0;
  if (coef > 3) coef = 3;

  const sashWmm = Number(sashWInput.value)||0;
  const sashHmm = Number(sashHInput.value)||0;
  const area = sashWmm * sashHmm * coef / 1_000_000;

  lastCalc = {verticalMm, horizontalMm, slope, coef, area, zoneText: label};

  log(
    `é«˜ã•(æ­£é¢) = ${verticalMm.toFixed(1)} mm\n`+
    `å¥¥è¡Œ(å´é¢) = ${horizontalMm.toFixed(1)} mm\n`+
    `å‚¾ã(å¥¥è¡Œ/é«˜ã•) = ${slope.toFixed(3)}\n`+
    `ç”¨é€”åœ°åŸŸ = ${label}\n`+
    `æ¡å…‰è£œæ­£ä¿‚æ•° = ${coef.toFixed(2)}\n`+
    `æœ‰åŠ¹æ¡å…‰é¢ç© = ${area.toFixed(3)} mÂ²`
  );
}

/* ==== å€‹åˆ¥ç”»é¢PNG ==== */
function exportCanvasPair(imgCv, drawCv, filename){
  const exp = document.createElement('canvas');
  exp.width  = imgCv.width;
  exp.height = imgCv.height;
  const c = exp.getContext('2d');
  c.drawImage(imgCv,0,0);
  c.drawImage(drawCv,0,0);
  const a = document.createElement('a');
  a.download = filename;
  a.href = exp.toDataURL('image/png');
  a.click();
}
document.getElementById('frontExportBtn').addEventListener('click', ()=>{
  exportCanvasPair(frontImgCv, frontDrawCv, `front_${frontViewSelect.value}.png`);
});
document.getElementById('sideExportBtn').addEventListener('click', ()=>{
  exportCanvasPair(sideImgCv, sideDrawCv, `side_${sideViewSelect.value}.png`);
});

/* ==== 2ç”»é¢ï¼‹è¨ˆç®—å€¤ã‚’æ¨ªä¸¦ã³ä¿å­˜ ==== */
document.getElementById('exportAllBtn').addEventListener('click', ()=>{
  const exp = document.createElement('canvas');
  exp.width  = frontImgCv.width + sideImgCv.width;
  exp.height = Math.max(frontImgCv.height, sideImgCv.height) + 100;
  const ctx = exp.getContext('2d');

  ctx.drawImage(frontImgCv,0,0);
  ctx.drawImage(frontDrawCv,0,0);
  ctx.drawImage(sideImgCv,frontImgCv.width,0);
  ctx.drawImage(sideDrawCv,frontImgCv.width,0);

  ctx.fillStyle='white';
  ctx.fillRect(0, exp.height-100, exp.width, 100);
  ctx.fillStyle='black';
  ctx.font='14px sans-serif';
  const t1 = `é«˜ã•=${lastCalc.verticalMm.toFixed(1)}mm / å¥¥è¡Œ=${lastCalc.horizontalMm.toFixed(1)}mm / å‚¾ã=${lastCalc.slope.toFixed(3)}`;
  const t2 = `ç”¨é€”=${lastCalc.zoneText} / æ¡å…‰è£œæ­£ä¿‚æ•°=${lastCalc.coef.toFixed(2)} / æœ‰åŠ¹æ¡å…‰é¢ç©=${lastCalc.area.toFixed(3)}mÂ²`;
  ctx.fillText(t1, 10, exp.height-70);
  ctx.fillText(t2, 10, exp.height-45);

  const now=new Date();
  const fname=`result_${now.getFullYear()}${('0'+(now.getMonth()+1)).slice(-2)}${('0'+now.getDate()).slice(-2)}_${('0'+now.getHours()).slice(-2)}${('0'+now.getMinutes()).slice(-2)}${('0'+now.getSeconds()).slice(-2)}.png`;
  const a=document.createElement('a');
  a.download=fname;
  a.href=exp.toDataURL('image/png');
  a.click();
});

/* ==== åˆæœŸæç”» ==== */
redrawFront();
redrawSide();
calcCoefficient();
</script>
</body>
</html>
